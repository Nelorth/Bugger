<ui:composition template="/WEB-INF/template/main.xhtml"
                xmlns="http://www.w3.org/1999/xhtml"
                xmlns:h="http://xmlns.jcp.org/jsf/html"
                xmlns:f="http://xmlns.jcp.org/jsf/core"
                xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
                xmlns:b="http://tech.bugger/tags"
                xmlns:a="http://xmlns.jcp.org/jsf/passthrough">
    <ui:param name="title" value="#{(labels.profile_page).concat(' ').concat(profileBacker.user.username)}"/>
    <f:metadata>
        <f:importConstants type="tech.bugger.global.util.Constants" var="C"/>
        <f:importConstants type="tech.bugger.control.backing.ProfileBacker.ProfileDialog" var="P"/>
        <f:importConstants type="tech.bugger.global.transfer.User.ProfileVisibility" var="V"/>
    </f:metadata>

    <ui:define name="content">

        <h:panelGroup id="p-profile-info" styleClass="d-flex p-2 justify-content-center align-items-center container">
            <h:panelGroup layout="block" styleClass="row vw-90">
                <!-- Renders the profile owner's user information and subscriptions. -->
                <h:form id="f-profile">

                    <!-- Contains the buttons for changing administration status, profile editing and subscribing -->
                    <h:panelGroup id="p-profile-buttons" layout="block" styleClass="row">
                        <h:panelGroup styleClass="col-sm-12 align-right">
                            <h:commandButton id="cb-subscribe" action="#{profileBacker.toggleUserSubscription()}"
                                             value="#{labels.subscribe}" styleClass="button"
                                             rendered="#{userSession.user != null and userSession.user.id
                                             != profileBacker.user.id}"/>
                            <h:commandLink id="l-admin" action="#{profileBacker.openPromoteDemoteAdminDialog}"
                                           styleClass="command-link" rendered="#{userSession.user.administrator
                                           and not profileBacker.user.administrator}">
                                <h:graphicImage id="g-admin" value="/resources/images/add.png"
                                                alt="Button to add admin"/>
                            </h:commandLink>
                            <h:commandLink id="l-rem-admin" action="#{profileBacker.openPromoteDemoteAdminDialog}"
                                           immediate="true" styleClass="command-link"
                                           rendered="#{userSession.user.administrator
                                       and profileBacker.user.administrator}">
                                <h:graphicImage id="g-rem-admin" value="/resources/images/delete.png"
                                                alt="Button to remove admin"/>
                            </h:commandLink>
                            <h:link id="l-edit" value="#{labels.edit}" outcome="/view/restr/profile-edit.xhtml"
                                    rendered="#{profileBacker.privileged}" styleClass="button style-button">
                                <f:param name="e" value="#{profileBacker.user.username}"/>
                            </h:link>
                        </h:panelGroup>
                    </h:panelGroup>

                    <!-- The profile owner's user information -->
                    <h:panelGroup id="p-avatar" layout="block" styleClass="row p-avatar">
                        <h:graphicImage id="g-avatar" value="avatar?id=#{profileBacker.user.id}" styleClass="g-avatar"
                                        alt="The user's avatar" rendered="#{profileBacker.user.existsAvatar}"/>
                        <h:graphicImage id="g-avatar-fallback" library="images" name="bugger.png" styleClass="g-avatar"
                                        alt="The user's avatar" rendered="#{not profileBacker.user.existsAvatar}"/>
                    </h:panelGroup>
                    <h:panelGroup id="p-username" layout="block" styleClass="row">
                        <h:panelGroup id="p-username-label" styleClass="col-sm-3">
                            <h:outputLabel id="ol-username" value="#{labels.username}" for="ot-username"
                                           styleClass="form-label"/>
                        </h:panelGroup>
                        <h:panelGroup id="p-username-output" styleClass="col-sm-9">
                            <h:outputText id="ot-username" value="#{profileBacker.user.username}"
                                          styleClass="profile-info"/>
                        </h:panelGroup>
                    </h:panelGroup>
                    <h:panelGroup id="p-first-name" layout="block" styleClass="row"
                                  rendered="#{profileBacker.user.profileVisibility == V.FULL
                                  or profileBacker.privileged}">
                        <h:panelGroup id="p-first-name-label" styleClass="col-sm-3">
                            <h:outputLabel id="ol-first-name" value="#{labels.first_name}" for="ot-first-name"
                                           styleClass="form-label"/>
                        </h:panelGroup>
                        <h:panelGroup id="p-first-name-output" styleClass="col-sm-9">
                            <h:outputText id="ot-first-name" value="#{profileBacker.user.firstName}"
                                          styleClass="profile-info"/>
                        </h:panelGroup>
                    </h:panelGroup>
                    <h:panelGroup id="p-last-name" layout="block" styleClass="row"
                                  rendered="#{profileBacker.user.profileVisibility == V.FULL
                                  or profileBacker.privileged}">
                        <h:panelGroup id="p-last-name-label" styleClass="col-sm-3">
                            <h:outputLabel id="ol-last-name" value="#{labels.last_name}" for="ot-last-name"
                                           styleClass="form-label"/>
                        </h:panelGroup>
                        <h:panelGroup id="p-last-name-output" styleClass="col-sm-9">
                            <h:outputText id="ot-last-name" value="#{profileBacker.user.lastName}"
                                          styleClass="profile-info"/>
                        </h:panelGroup>
                    </h:panelGroup>
                    <h:panelGroup id="p-email" layout="block" styleClass="row"
                                  rendered="#{profileBacker.user.profileVisibility == V.FULL
                                  or profileBacker.privileged}">
                        <h:panelGroup id="p-email-label" styleClass="col-sm-3">
                            <h:outputLabel id="ol-email" value="#{labels.email}" for="ot-email"
                                           styleClass="form-label"/>
                        </h:panelGroup>
                        <h:panelGroup id="p-email-output" styleClass="col-sm-9">
                            <h:outputText id="ot-email" value="#{profileBacker.user.emailAddress}"
                                          styleClass="profile-info"/>
                        </h:panelGroup>
                    </h:panelGroup>
                    <h:panelGroup id="p-biography" layout="block" styleClass="row"
                                  rendered="#{profileBacker.user.profileVisibility == V.FULL
                                  or profileBacker.privileged}">
                        <h:panelGroup id="p-biography-label" styleClass="col-sm-3">
                            <h:outputLabel id="ol-biography" value="#{labels.biography}" for="ot-biography"
                                           styleClass="form-label"/>
                        </h:panelGroup>
                        <h:panelGroup id="p-biography-output" styleClass="col-sm-9">
                            <h:outputText id="ot-biography" value="#{profileBacker.sanitizedBiography}" escape="false"
                                          styleClass="profile-info"/>
                        </h:panelGroup>
                    </h:panelGroup>
                    <h:panelGroup id="p-weight" layout="block" styleClass="row">
                        <h:panelGroup id="p-weight-label" styleClass="col-sm-3">
                            <h:outputLabel id="ol-weight" value="#{labels.voting_weight}" for="ot-weight"
                                           styleClass="form-label"/>
                        </h:panelGroup>
                        <h:panelGroup id="p-weight-output" styleClass="col-sm-9">
                            <h:outputText id="ot-weight" value="#{profileBacker.votingWeight}"
                                          styleClass="profile-info"/>
                        </h:panelGroup>
                    </h:panelGroup>
                    <h:panelGroup id="p-post-count" layout="block" styleClass="row">
                        <h:panelGroup id="p-post-count-label" styleClass="col-sm-3">
                            <h:outputLabel id="ol-post-count" value="#{labels.num_posts}" for="ot-post-count"
                                           styleClass="form-label"/>
                        </h:panelGroup>
                        <h:panelGroup id="p-post-count-output" styleClass="col-sm-9">
                            <h:outputText id="ot-post-count" value="#{profileBacker.numberOfPosts}"
                                          styleClass="profile-info"/>
                        </h:panelGroup>
                    </h:panelGroup>
                    <h:panelGroup id="p-is-admin" layout="block" styleClass="row"
                                  rendered="#{profileBacker.user.administrator}">
                        <h:panelGroup id="p-is-admin-label" styleClass="col-sm-3">
                            <h:outputLabel id="ol-is-admin" value="#{labels.status}" for="ot-is-admin"
                                           styleClass="form-label"/>
                        </h:panelGroup>
                        <h:panelGroup id="p-is-admin-output" styleClass="col-sm-9">
                            <h:outputText id="ot-is-admin" value="#{labels.administrator}" styleClass="profile-info"/>
                        </h:panelGroup>
                    </h:panelGroup>
                    <h:panelGroup id="p-register-date" layout="block" styleClass="row">
                        <h:panelGroup id="p-register-date-label" styleClass="col-sm-3">
                            <h:outputLabel id="ol-register-date" value="#{labels.registration_date}"
                                           for="ot-register-date" styleClass="form-label"/>
                        </h:panelGroup>
                        <h:panelGroup id="p-register-date-output" styleClass="col-sm-9">
                            <h:outputText id="ot-register-date" value="#{profileBacker.user.registrationDate}"
                                          styleClass="profile-info"/>
                        </h:panelGroup>
                    </h:panelGroup>
                </h:form>

                <!-- A paginated list of topics moderated by the profile owner. -->
                <h:outputText id="ot-moderated" styleClass="h2 profile-h2" value="#{labels.mod_topics}"/>
                <h:panelGroup id="p-moderated" layout="block" styleClass="row">
                    <h:panelGroup id="p-moderated-pagination" layout="block" styleClass="col-sm-12"
                                  rendered="#{not profileBacker.user.administrator}">
                        <b:pagitable paginator="#{profileBacker.moderatedTopics}" simple="true">
                            <!--@elvariable id="var" type="tech.bugger.global.transfer.Topic"-->
                            <h:column>
                                <h:link value="#{var.title}" outcome="pretty:topic">
                                    <f:param name="id" value="#{var.id}"/>
                                </h:link>
                            </h:column>
                        </b:pagitable>
                    </h:panelGroup>
                    <h:panelGroup id="p-moderated-admin" layout="block" styleClass="col-sm-12"
                                  rendered="#{profileBacker.user.administrator}">
                        <h:outputText styleClass="small form-text text-muted" value="#{labels.mod_admin}"/>
                    </h:panelGroup>
                </h:panelGroup>

                <!-- Renders the title and command button of the profile owner's subscribed topics. This form is
                necessary since the pagitable contains an additional form. -->
                <h:form id="f-sub-topics">
                    <h:outputText id="ot-sub-topics" styleClass="h2 profile-h2" value="#{labels.topic_subs}"
                                  rendered="#{profileBacker.privileged}"/>
                    <h:panelGroup id="p-unsub-all-topics" layout="block" styleClass="row">
                        <h:panelGroup styleClass="col-sm-12 align-right">
                            <h:commandButton id="cb-unsub-all-topics"
                                             action="#{profileBacker.openDeleteAllTopicSubscriptionsDialog}"
                                             rendered="#{not profileBacker.topicSubscriptions.isEmpty()
                                             and profileBacker.privileged}" value="#{labels.unsub_all}"
                                             styleClass="button"/>
                        </h:panelGroup>
                    </h:panelGroup>
                </h:form>

                <!-- A paginated list of the profile owner's subscribed topics. -->
                <h:panelGroup id="p-sub-topics" styleClass="row" layout="block" rendered="#{profileBacker.privileged}">
                    <h:panelGroup id="p-sub-topics-pagination" styleClass="col-sm-12" layout="block">
                        <b:pagitable paginator="#{profileBacker.topicSubscriptions}">
                            <b:column title="ID" paginator="#{profileBacker.topicSubscriptions}" key="id">
                                <!--@elvariable id="var" type="tech.bugger.global.transfer.Topic"-->
                                <h:outputText value="#{var}"/>
                            </b:column>
                        </b:pagitable>
                    </h:panelGroup>
                </h:panelGroup>

                <!-- Same as previous form for reports -->
                <h:form id="f-sub-reports">
                    <h:outputText id="ot-sub-reports" styleClass="h2 profile-h2" value="#{labels.report_subs}"
                                  rendered="#{profileBacker.privileged}"/>
                    <h:panelGroup id="p-unsub-all-reports" layout="block" styleClass="row">
                        <h:panelGroup styleClass="col-sm-12 align-right">
                            <h:commandButton id="cb-unsub-all-reports"
                                             action="#{profileBacker.openDeleteAllReportSubscriptionsDialog}"
                                             rendered="#{not profileBacker.reportSubscriptions.isEmpty()
                                             and profileBacker.privileged}" value="#{labels.unsub_all}"
                                             styleClass="button"/>
                        </h:panelGroup>
                    </h:panelGroup>
                </h:form>

                <!-- A paginated list of the profile owner's subscribed reports. -->
                <h:panelGroup id="p-sub-reports" layout="block" styleClass="row" rendered="#{profileBacker.privileged}">
                    <h:panelGroup id="p-sub-reports-pagination" layout="block" styleClass="col-sm-12">
                        <b:pagitable paginator="#{profileBacker.reportSubscriptions}">
                            <b:column title="ID" paginator="#{profileBacker.reportSubscriptions}" key="id">
                                <!--@elvariable id="var" type="tech.bugger.global.transfer.Report"-->
                                <h:outputText value="#{var}"/>
                            </b:column>
                        </b:pagitable>
                    </h:panelGroup>
                </h:panelGroup>

                <!-- Same as previous form for users -->
                <h:form id="f-sub-users">
                    <h:outputText id="ot-sub-users" styleClass="h2 profile-h2" value="#{labels.user_subs}"
                                  rendered="#{profileBacker.privileged}"/>
                    <h:panelGroup id="p-unsub-all-users" layout="block" styleClass="row">
                        <h:panelGroup styleClass="col-sm-12 align-right">
                            <h:commandButton id="cb-unsub-all-users"
                                             action="#{profileBacker.openDeleteAllUserSubscriptionsDialog}"
                                             rendered="#{not profileBacker.userSubscriptions.isEmpty()
                                             and profileBacker.privileged}" value="#{labels.unsub_all}"
                                             styleClass="button"/>
                        </h:panelGroup>
                    </h:panelGroup>
                </h:form>

                <!-- A paginated list of the profile owner's subscribed users. -->
                <h:panelGroup id="p-sub-users" layout="block" styleClass="row" rendered="#{profileBacker.privileged}">
                    <h:panelGroup id="p-sub-users-pagination" layout="block" styleClass="col-sm-12">
                        <b:pagitable paginator="#{profileBacker.userSubscriptions}">
                            <b:column title="ID" paginator="#{profileBacker.userSubscriptions}" key="id">
                                <!--@elvariable id="var" type="tech.bugger.global.transfer.User"-->
                                <h:outputText value="#{var}"/>
                            </b:column>
                        </b:pagitable>
                    </h:panelGroup>
                </h:panelGroup>
            </h:panelGroup>
        </h:panelGroup>
    </ui:define>

    <ui:define name="dialogs">
        <!-- Renders the popup dialog for changing the profile owner's administrator status. -->
        <h:panelGroup layout="block" styleClass="dialog" rendered="#{profileBacker.profileDialog == P.ADMIN}">
            <h:form id="f-change-status">
                <h:outputText id="ot-change-status" styleClass="h2" value="#{labels.change_admin_status}"/>
                <h:panelGroup layout="block" styleClass="mb-3">
                    <h:outputText id="ot-change-status-info" value="#{labels.really_change_admin_status}"/>
                </h:panelGroup>
                <h:panelGroup id="p-user-password" layout="block"
                              styleClass="mb-3 form-group has-validation position-relative">
                    <h:panelGroup id="p-user-password-label" styleClass="row align-center">
                        <h:outputLabel id="ol-user-password" value="#{labels.password}" for="i-user-password"
                                       styleClass="form-label"/>
                    </h:panelGroup>
                    <h:panelGroup id="p-user-password-input" layout="block" styleClass="input-group has-validation">
                        <h:inputSecret id="i-user-password" value="#{profileBacker.password}" required="true"
                                       a:maxlength="#{C.PASSWORD_MAX}" styleClass="form-control
                                       #{!facesContext.validationFailed ? '' : component.valid ? 'is-valid'
                                       : 'is-invalid'}" a:placeholder="#{labels.password}">
                            <f:validateLength maximum="#{C.PASSWORD_MAX}"/>
                        </h:inputSecret>
                    </h:panelGroup>
                    <h:panelGroup id="p-user-password-message" layout="block" styleClass="invalid-tooltip end-0">
                        <h:message for="i-user-password"/>
                    </h:panelGroup>
                </h:panelGroup>
                <h:panelGroup layout="block" styleClass="row">
                    <h:panelGroup layout="block" styleClass="col-sm-12 align-center">
                        <h:commandButton id="cb-change-status" value="#{labels.change_status}"
                                         action="#{profileBacker.toggleAdmin}" styleClass="button"/>
                        <h:commandButton id="cb-abort-change" value="#{labels.abort}" styleClass="button"
                                         action="#{profileBacker.closeDialog}" immediate="true"/>
                    </h:panelGroup>
                </h:panelGroup>
            </h:form>
        </h:panelGroup>

        <!-- Renders the popup dialog to unsubscribe all of the profile owner's subscribed topics. -->
        <h:panelGroup layout="block" styleClass="dialog" rendered="#{profileBacker.profileDialog == P.TOPIC}">
            <h:form id="f-really-unsub-topics">
                <h:outputText id="ot-really-unsub-topics" styleClass="h2" value="#{labels.unsub_all_topics}"/>
                <h:panelGroup layout="block" styleClass="mb-3">
                    <h:outputText id="ot-really-unsub-topics-warn" value="#{labels.really_unsub_all_topics}"/>
                </h:panelGroup>
                <h:panelGroup layout="block" styleClass="row">
                    <h:panelGroup layout="block" styleClass="col-sm-12 align-center">
                        <h:commandButton id="cb-really-unsub-topics" value="#{labels.really_unsub}"
                                         action="#{profileBacker.deleteAllTopicSubscriptions}" styleClass="button"/>
                        <h:commandButton id="cb-abort-unsub-topics" value="#{labels.abort}" styleClass="button"
                                         action="#{profileBacker.closeDialog}"/>
                    </h:panelGroup>
                </h:panelGroup>
            </h:form>
        </h:panelGroup>

        <!-- Renders the popup dialog to unsubscribe all of the profile owner's subscribed reports. -->
        <h:panelGroup layout="block" styleClass="dialog" rendered="#{profileBacker.profileDialog == P.REPORT}">
            <h:form id="f-really-unsub-reports">
                <h:outputText id="ot-really-unsub-reports" styleClass="h2" value="#{labels.unsub_all_reports}"/>
                <h:panelGroup layout="block" styleClass="mb-3">
                    <h:outputText id="ot-really-unsub-reports-warn" value="#{labels.really_unsub_all_reports}"/>
                </h:panelGroup>
                <h:panelGroup layout="block" styleClass="row">
                    <h:panelGroup layout="block" styleClass="col-sm-12 align-center">
                        <h:commandButton id="cb-really-unsub-reports" value="#{labels.really_unsub}"
                                         action="#{profileBacker.deleteAllReportSubscriptions}" styleClass="button"/>
                        <h:commandButton id="cb-abort-unsub-reports" value="#{labels.abort}" styleClass="button"
                                         action="#{profileBacker.closeDialog}"/>
                    </h:panelGroup>
                </h:panelGroup>
            </h:form>
        </h:panelGroup>

        <!-- Renders the popup dialog to unsubscribe all of the profile owner's subscribed users. -->
        <h:panelGroup layout="block" styleClass="dialog" rendered="#{profileBacker.profileDialog == P.USER}">
            <h:form id="f-really-unsub-users">
                <h:outputText id="ot-really-unsub-users" styleClass="h2" value="#{labels.unsub_all_users}"/>
                <h:panelGroup layout="block" styleClass="mb-3">
                    <h:outputText id="ot-really-unsub-users-warn" value="#{labels.really_unsub_all_users}"/>
                </h:panelGroup>
                <h:panelGroup layout="block" styleClass="row">
                    <h:panelGroup layout="block" styleClass="col-sm-12 align-center">
                        <h:commandButton id="cb-really-unsub-users" value="#{labels.really_unsub}"
                                         action="#{profileBacker.deleteAllUserSubscriptions}" styleClass="button"/>
                        <h:commandButton id="cb-abort-unsub-users" value="#{labels.abort}" styleClass="button"
                                         action="#{profileBacker.closeDialog}"/>
                    </h:panelGroup>
                </h:panelGroup>
            </h:form>
        </h:panelGroup>
    </ui:define>
</ui:composition>