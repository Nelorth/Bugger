<ui:composition template="/WEB-INF/template/main.xhtml"
                xmlns="http://www.w3.org/1999/xhtml"
                xmlns:h="http://xmlns.jcp.org/jsf/html"
                xmlns:f="http://xmlns.jcp.org/jsf/core"
                xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
                xmlns:b="http://tech.bugger/tags">

    <ui:param name="title" value="#{reportBacker.report.title}"/>
    <f:metadata>
        <f:importConstants type="tech.bugger.global.util.Constants" var="C"/>
    </f:metadata>

    <ui:define name="dialogs">
        <h:panelGroup layout="block" styleClass="dialog" rendered="#{reportBacker.currentDialog == 'DUPLICATE'}">
            <h:outputText value="#{labels.report_duplicate_dialog_title}" styleClass="h2"/>
            <h:panelGroup layout="block" styleClass="mb-3">
                <h:outputText id="ot-duplicate" value="#{labels.report_duplicate_dialog_desc}"/>
            </h:panelGroup><!--converterMessage="#{messages.validate_nonnegative_number}"-->
            <h:form id="f-duplicate">
                <h:panelGroup layout="block" styleClass="mb-3 input-group">
                    <h:outputLabel styleClass="input-group-text" id="ol-username-icon">#</h:outputLabel>
                    <h:inputText id="it-duplicate" value="#{reportBacker.duplicateOfID}"
                                 styleClass="form-control#{component.valid ? '' : ' border-danger'}"/>
                </h:panelGroup>
                <h:panelGroup layout="block" styleClass="mb-3">
                    <h:message for="it-duplicate" styleClass="text-danger"/>
                </h:panelGroup>
                <h:panelGroup layout="block" styleClass="mb-3 d-flex justify-content-center">
                    <h:commandButton id="cb-duplicate-submit" styleClass="hide" action="#{reportBacker.markDuplicate}"/>
                    <h:commandButton id="cb-abort-duplicate" value="#{labels.cancel}"
                                     styleClass="btn btn-secondary me-3" action="#{reportBacker.displayDialog(null)}"/>
                    <h:commandButton id="cb-duplicate" value="#{labels.ok}" styleClass="btn btn-primary"
                                     action="#{reportBacker.markDuplicate}"/>
                </h:panelGroup>
            </h:form>
        </h:panelGroup>

        <h:panelGroup layout="block" styleClass="dialog" rendered="#{reportBacker.currentDialog == 'DELETE_REPORT'}">
            <h:form id="f-delete-report">
                <h:panelGroup class="row" layout="block" styleClass="align-center">
                    <h:panelGroup class="col-sm-4" layout="block"/>
                    <h:panelGroup class="col-sm-4" layout="block">
                        <h:panelGroup class="row" layout="block">
                            <h:outputText value="#{labels.report_delete_dialog}"/>
                        </h:panelGroup>
                        <h:panelGroup class="row" layout="block">
                            <h:commandButton id="cb-delete-report" action="#{reportBacker.delete}" styleClass="button"
                                             value="#{labels.delete}"/>
                            <h:commandButton id="cb-delete-report-cancel" action="#{reportBacker.displayDialog(null)}"
                                             styleClass="button" value="#{labels.cancel}"/>
                        </h:panelGroup>
                    </h:panelGroup>
                    <h:panelGroup class="col-sm-4" layout="block"/>
                </h:panelGroup>
            </h:form>
        </h:panelGroup>

        <h:panelGroup layout="block" styleClass="dialog" rendered="#{reportBacker.currentDialog == 'OPEN_CLOSE'}">
            <h:form id="f-open-close-report">
                <h:panelGroup class="row" layout="block" styleClass="align-center">
                    <h:panelGroup class="col-sm-4" layout="block"/>
                    <h:panelGroup class="col-sm-4" layout="block">
                        <h:panelGroup class="row" layout="block">
                            <h:outputText
                                    value="#{reportBacker.report.closingDate == null ? labels.report_close_dialog : labels.report_open_dialog}"/>
                        </h:panelGroup>
                        <h:panelGroup class="row" layout="block">
                            <h:commandButton id="cb-open-close-report" action="#{reportBacker.toggleOpenClosed}"
                                             styleClass="button"
                                             value="#{reportBacker.report.closingDate == null ? labels.report_action_close : labels.report_action_open}"/>
                            <h:commandButton id="cb-open-close-report-cancel"
                                             action="#{reportBacker.displayDialog(null)}"
                                             styleClass="button" value="#{labels.cancel}"/>
                        </h:panelGroup>
                    </h:panelGroup>
                    <h:panelGroup class="col-sm-4" layout="block"/>
                </h:panelGroup>
            </h:form>
        </h:panelGroup>

        <h:panelGroup layout="block" styleClass="dialog" rendered="#{reportBacker.currentDialog == 'DELETE_POST'}">
            <h:form id="f-delete-post">
                <h:panelGroup class="row" layout="block" styleClass="align-center">
                    <h:panelGroup class="col-sm-4" layout="block"/>
                    <h:panelGroup class="col-sm-4" layout="block">
                        <h:panelGroup class="row" layout="block">
                            <h:outputFormat value="#{labels.report_delete_post_dialog}">
                                <f:param value="#{reportBacker.postToBeDeleted.id}"/>
                            </h:outputFormat>
                        </h:panelGroup>
                        <h:panelGroup class="row" layout="block">
                            <h:commandButton id="cb-delete-post" action="#{reportBacker.deletePost}" styleClass="button"
                                             value="#{labels.delete}"/>
                            <h:commandButton id="cb-delete-post-cancel" action="#{reportBacker.displayDialog(null)}"
                                             styleClass="button" value="#{labels.cancel}"/>
                        </h:panelGroup>
                    </h:panelGroup>
                    <h:panelGroup class="col-sm-4" layout="block"/>
                </h:panelGroup>
            </h:form>
        </h:panelGroup>
    </ui:define>

    <ui:define name="content">
        <h:form>
            <h:panelGroup rendered="#{userSession.user != null}">
                <h:commandButton value="#{labels.upvote_button}" action="#{reportBacker.removeVote}"
                                 rendered="#{reportBacker.hasUpvoted}" styleClass="vote-cast"/>
                <h:commandButton value="#{labels.upvote_button}" action="#{reportBacker.upvote}"
                                 rendered="#{!reportBacker.hasUpvoted}" styleClass="vote-not-cast"/>
                <h:commandButton value="#{labels.downvote_button}" action="#{reportBacker.removeVote}"
                                 rendered="#{reportBacker.hasDownvoted}" styleClass="vote-cast"/>
                <h:commandButton value="#{labels.downvote_button}" action="#{reportBacker.downvote}"
                                 rendered="#{!reportBacker.hasDownvoted}" styleClass="vote-not-cast"/>
                <h:outputLabel value="#{labels.relevance_overwritten}" rendered="#{reportBacker.overwriteRelevance}"/>
                <h:outputLabel value="#{labels.current_relevance}:&#xA0;"/>
                <h:outputLabel value="#{reportBacker.report.relevance}"/>
                <h:panelGroup rendered="#{reportBacker.privileged}">
                    <h:inputText value="#{reportBacker.overwriteRelevanceValue}"/>
                    <h:commandButton value="#{labels.overwrite_relevance}"
                                     action="#{reportBacker.applyOverwriteRelevance}"/>
                </h:panelGroup>
            </h:panelGroup>
        </h:form>
        <h:panelGrid columns="5">
            <h:outputText id="ot-id" value="#{labels.id}: #{reportBacker.report.id}"/>
            <h:outputText id="ot-status"
                          value="#{labels.status}: #{reportBacker.report.closingDate == null ? labels.report_status_open : labels.report_status_closed.concat(' ').concat(reportBacker.report.closingDate)}"/>
            <h:outputText id="ot-type"
                          value="#{labels.report_type}: #{labels['report_type.'.concat(reportBacker.report.type)]}"/>
            <h:outputLabel id="ol-duplicate-desc" rendered="#{reportBacker.report.duplicateOf != null}"
                           value="#{labels.report_original}: "/>
            <h:link id="l-duplicate" outcome="pretty:report" rendered="#{reportBacker.report.duplicateOf != null}"
                    value="##{reportBacker.report.duplicateOf}">
                <f:param name="id" value="#{reportBacker.report.duplicateOf}"/>
            </h:link>
            <h:outputText id="ot-severity"
                          value="#{labels.report_severity}: #{labels['report_severity.'.concat(reportBacker.report.severity)]}"/>
            <h:outputText id="ot-version" value="#{labels.report_version}: #{reportBacker.report.version}"/>
            <b:pagitable id="p-duplicates" paginator="#{reportBacker.duplicates}" simple="true"
                         rendered="#{not reportBacker.duplicates.isEmpty()}">
                <!--@elvariable id="var" type="tech.bugger.global.transfer.Report"-->
                <b:column title="#{labels.report_duplicates}" paginator="#{reportBacker.duplicates}" key="ID">
                    <h:link outcome="pretty:report" value="##{var.id}">
                        <f:param name="id" value="#{var.id}"/>
                    </h:link>
                </b:column>
            </b:pagitable>
        </h:panelGrid>
        <h:panelGrid columns="3">
            <h:outputText id="ot-creator"
                          value="#{labels.report_created_by}: #{reportBacker.report.authorship.creator == null ? labels.deleted_user : reportBacker.report.authorship.creator.username}"/>
            <h:outputText id="ot-created-at"
                          value="#{labels.report_at} #{reportBacker.report.authorship.creationDate}"/>
            <h:panelGroup>
                <h:graphicImage id="g-creator-thumbnail-r#{reportBacker.report.id}"
                                value="avatar?id=#{reportBacker.report.authorship.creator == null ? 0 : reportBacker.report.authorship.creator.id}&amp;type=thumbnail"
                                styleClass="g-avatar-thumbnail"
                                alt="#{reportBacker.report.authorship.creator == null ? labels.deleted_user : reportBacker.report.authorship.creator.username}'s avatar"
                                rendered="#{reportBacker.report.authorship.creator != null and reportBacker.report.authorship.creator.existsAvatar}"/>
                <h:graphicImage id="g-creator-thumbnail-fallback-r#{reportBacker.report.id}"
                                library="images" name="bugger.png"
                                styleClass="g-avatar-thumbnail"
                                alt="#{reportBacker.report.authorship.creator == null ? labels.deleted_user : reportBacker.report.authorship.creator.username}'s avatar"
                                rendered="#{reportBacker.report.authorship.creator == null or !reportBacker.report.authorship.creator.existsAvatar}"/>
            </h:panelGroup>

            <h:outputText id="ot-modifier"
                          value="#{labels.report_last_modified_by}: #{reportBacker.report.authorship.modifier == null ? labels.deleted_user : reportBacker.report.authorship.modifier.username}"
                          rendered="#{reportBacker.report.authorship.modifiedDate != null}"/>
            <h:outputText id="ot-modified-at"
                          value="#{labels.report_at} #{reportBacker.report.authorship.modifiedDate}"
                          rendered="#{reportBacker.report.authorship.modifiedDate != null}"/>
            <h:panelGroup>
                <h:graphicImage id="g-modifier-thumbnail-r#{reportBacker.report.id}"
                                value="avatar?id=#{reportBacker.report.authorship.modifier == null ? 0 : reportBacker.report.authorship.modifier.id}&amp;type=thumbnail"
                                styleClass="g-avatar-thumbnail"
                                alt="#{reportBacker.report.authorship.modifier == null ? labels.deleted_user : reportBacker.report.authorship.modifier.username}'s avatar"
                                rendered="#{reportBacker.report.authorship.modifier != null and reportBacker.report.authorship.modifier.existsAvatar}"/>
                <h:graphicImage id="g-modifier-thumbnail-fallback-r#{reportBacker.report.id}"
                                library="images" name="bugger.png"
                                styleClass="g-avatar-thumbnail"
                                alt="#{reportBacker.report.authorship.modifier == null ? labels.deleted_user : reportBacker.report.authorship.modifier.username}'s avatar"
                                rendered="#{reportBacker.report.authorship.modifier == null or !reportBacker.report.authorship.modifier.existsAvatar}"/>
            </h:panelGroup>
        </h:panelGrid>
        <h:form id="f-report">
            <h:panelGrid rendered="#{reportBacker.privileged}">
                <h:commandButton id="cb-open-close-report-dialog" action="#{reportBacker.displayDialog('OPEN_CLOSE')}"
                                 value="#{reportBacker.report.closingDate == null ? labels.report_action_close : labels.report_action_open}"
                                 styleClass="btn btn-primary"/>
                <h:link id="cb-edit-report" value="#{labels.edit}" outcome="pretty:report-edit"
                        styleClass="btn btn-secondary">
                    <f:param name="id" value="#{reportBacker.report.id}"/>
                </h:link>
                <h:commandButton id="cb-delete-report-dialog" action="#{reportBacker.displayDialog('DELETE_REPORT')}"
                                 value="#{labels.delete}" styleClass="btn btn-secondary"/>
                <h:commandButton id="cb-mark-duplicate" action="#{reportBacker.displayDialog('DUPLICATE')}"
                                 value="#{labels.report_mark_duplicate}" styleClass="btn btn-secondary"/>
                <h:commandButton id="cb-unmark-duplicate" action="#{reportBacker.unmarkDuplicate}"
                                 value="#{labels.report_unmark_duplicate}" styleClass="btn btn-secondary"
                                 rendered="#{reportBacker.report.duplicateOf != null}"/>
            </h:panelGrid>
            <h:panelGrid rendered="#{userSession.user != null}">
                <h:commandButton id="cb-subscribe" action="#{reportBacker.toggleReportSubscription}"
                                 value="#{reportBacker.subscribed ? labels.unsubscribe : labels.subscribe}" styleClass="btn btn-secondary"/>
            </h:panelGrid>
        </h:form>

        <h:link id="cb-add-post"
                outcome="pretty:post-edit"
                value="#{labels.post_create}"
                styleClass="btn btn-primary"
                rendered="#{reportBacker.loggedIn and !reportBacker.banned}">
            <f:param name="r" value="#{reportBacker.report.id}"/>
            <f:param name="c" value="1"/>
        </h:link>

        <b:pagitable_post paginator="#{reportBacker.posts}">
            <!--@elvariable id="var" type="tech.bugger.global.transfer.Post"-->
            <h:panelGroup layout="block" styleClass="mb-3">
                <!-- div used here because of: https://stackoverflow.com/questions/18358604/ -->
                <div class="card" id="post-#{var.id}">
                    <h:panelGroup layout="block" styleClass="card-header">
                        <h:panelGroup layout="block" styleClass="d-flex justify-content-between">
                            <h:panelGroup layout="block" styleClass="align-vcenter">
                                <h:outputText id="ot-post-creator" styleClass="row"
                                              value="#{var.authorship.creator == null
                                              ? labels.deleted_user
                                              : var.authorship.creator.username}"/>
                                <h:outputText id="ot-post-created-at" styleClass="row"
                                              value="#{labels.report_at} #{var.authorship.creationDate}"/>
                                <h:graphicImage id="g-creator-thumbnail-p#{var.id}"
                                                value="avatar?id=#{var.authorship.creator == null ? 0 : var.authorship.creator.id}&amp;type=thumbnail"
                                                styleClass="g-avatar-thumbnail"
                                                alt="#{var.authorship.creator == null ? labels.deleted_user : var.authorship.creator.username}'s avatar"
                                                rendered="#{var.authorship.creator != null and var.authorship.creator.existsAvatar}"/>
                                <h:graphicImage id="g-creator-thumbnail-fallback-p#{var.id}"
                                                library="images" name="bugger.png"
                                                styleClass="g-avatar-thumbnail"
                                                alt="#{var.authorship.creator == null ? labels.deleted_user : var.authorship.creator.username}'s avatar"
                                                rendered="#{var.authorship.creator == null or !var.authorship.creator.existsAvatar}"/>
                            </h:panelGroup>
                            <h:panelGroup layout="block" styleClass="align-vcenter"
                                          rendered="#{reportBacker.privilegedForPost(var)}">
                                <h:link id="cb-edit-post"
                                        outcome="pretty:post-edit"
                                        value="#{labels.edit}"
                                        styleClass="btn btn-secondary">
                                    <f:param name="p" value="#{var.id}"/>
                                </h:link>
                                <h:commandButton id="cb-delete-post-dialog"
                                                 styleClass="btn btn-primary"
                                                 action="#{reportBacker.deletePostDialog(var)}"
                                                 value="#{labels.delete}"/>
                            </h:panelGroup>
                        </h:panelGroup>
                    </h:panelGroup>
                    <!--
                    <h:panelGroup class="row" layout="block" styleClass="align-center">
                        <h:panelGroup class="col-sm-4" layout="block">
                            <h:panelGroup class="row" layout="block">
                                <h:outputText id="ot-post-creator" value="#{var.authorship.creator == null ? 'deleted user' : var.authorship.creator.username}"/>
                            </h:panelGroup>
                            <h:panelGroup class="row" layout="block">
                                <h:outputText id="ot-post-created-at" value="at #{var.authorship.creationDate}"/>
                            </h:panelGroup>
                        </h:panelGroup>
                        <h:panelGroup class="col-sm-4" layout="block"/>
                        <h:panelGroup class="col-sm-4" layout="block">
                            <h:commandButton id="cb-delete-post-dialog" action="#{reportBacker.deletePostDialog(var)}" value="#{labels.delete}"/>
                        </h:panelGroup>
                    </h:panelGroup>
                    -->

                    <h:panelGrid columns="1" styleClass="card-body">
                        <h:outputText value="#{var.content}" escape="false"/>
                    </h:panelGrid>

                    <!--
                    <h:panelGroup class="row" layout="block">
                        <h:outputText value="#{var.content}" escape="false"/>
                    </h:panelGroup>
                    -->

                    <h:panelGroup styleClass="card-footer">
                        <h:panelGrid columns="3">
                            <h:outputText value="#{labels.id}: #{var.id}"/>
                            <h:outputText
                                    value="#{labels.report_last_modified_by} #{var.authorship.modifier == null ? labels.deleted_user : var.authorship.modifier.username} #{labels.report_at} #{var.authorship.modifiedDate}"
                                    rendered="#{var.authorship.modifiedDate != null}"
                            />
                            <h:graphicImage id="g-modifier-thumbnail-p#{var.id}"
                                            value="avatar?id=#{var.authorship.modifier == null ? labels.deleted_user : var.authorship.modifier.id}&amp;type=thumbnail"
                                            styleClass="g-avatar-thumbnail"
                                            alt="#{var.authorship.modifier == null ? 0 : var.authorship.modifier.username}'s avatar"
                                            rendered="#{var.authorship.modifier != null and var.authorship.modifier.existsAvatar}"/>
                            <h:graphicImage id="g-modifier-thumbnail-fallback-p#{var.id}"
                                            library="images" name="bugger.png"
                                            styleClass="g-avatar-thumbnail"
                                            alt="#{var.authorship.modifier == null ? labels.deleted_user : var.authorship.modifier.username}'s avatar"
                                            rendered="#{var.authorship.modifier == null or !var.authorship.modifier.existsAvatar}"/>
                        </h:panelGrid>
                    </h:panelGroup>

                    <ul>
                        <ui:repeat var="attachment" value="#{var.attachments}">
                            <li>
                                <!-- TODO: Correct path to attachment servlet -->
                                <h:link outcome="attachment" value="#{attachment.name}">
                                    <f:param name="id" value="#{attachment.id}"/>
                                </h:link>
                            </li>
                        </ui:repeat>
                    </ul>
                </div>
            </h:panelGroup>
        </b:pagitable_post>
    </ui:define>
</ui:composition>
